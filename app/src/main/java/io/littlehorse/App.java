/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package io.littlehorse;

import io.littlehorse.common.LHConfig;
import io.littlehorse.common.util.LHUtil;
import io.littlehorse.server.LHServer;
import io.littlehorse.testworker.TestWorker;
import java.io.IOException;
import java.util.ArrayList;
import java.util.concurrent.ExecutionException;
import org.apache.kafka.clients.admin.NewTopic;

public class App {

    public static void doIdempotentSetup(LHConfig config)
        throws InterruptedException, ExecutionException {
        LHUtil.log("Creating topics!!");

        ArrayList<NewTopic> topics = new ArrayList<>();
        for (int i = 1; i <= 3; i++) {
            topics.add(
                new NewTopic(
                    "task" + i,
                    config.getTaskPartitions(),
                    config.getReplicationFactor()
                )
            );
        }

        topics.add(
            new NewTopic(
                config.getCoreCmdTopicName(),
                config.getClusterPartitions(),
                config.getReplicationFactor()
            )
        );

        topics.add(
            new NewTopic(
                config.getTimerTopic(),
                config.getClusterPartitions(),
                config.getReplicationFactor()
            )
        );

        topics.add(
            new NewTopic(
                config.getTagCmdTopic(),
                config.getClusterPartitions(),
                config.getReplicationFactor()
            )
        );

        for (NewTopic topic : topics) {
            config.createKafkaTopic(topic);
        }
        LHUtil.log("Done creating topics");
    }

    public static void main(String[] args)
        throws InterruptedException, ExecutionException, IOException {
        String arg = args[0];
        if (arg.equals("tester")) {
            tester();
            System.exit(0);
        }

        LHConfig config = new LHConfig();
        doIdempotentSetup(config);

        if (arg.equals("worker")) {
            TestWorker.doMain(config);
        } else if (arg.equals("server")) {
            LHServer.doMain(config);
        }
    }

    public static void tester() {
        System.out.println("TODO: experiment a bit");
    }
}
